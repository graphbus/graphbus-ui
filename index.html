<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GraphBus UI</title>
    <link rel="stylesheet" href="styles.css">
    <!-- vis.js for graph visualization -->
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        #graphCanvas {
            width: 100%;
            height: 100%;
            border: 1px solid #333;
            background: #1a1a1a;
        }

        /* Style vis.js navigation buttons for dark theme */
        .vis-network .vis-navigation .vis-button {
            background-color: rgba(102, 126, 234, 0.8) !important;
            border: 1px solid #667eea !important;
        }

        .vis-network .vis-navigation .vis-button:hover {
            background-color: rgba(129, 140, 248, 0.9) !important;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5) !important;
        }

        /* Make sure buttons are visible */
        .vis-network .vis-navigation {
            opacity: 1 !important;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Welcome Screen (shown on first load) -->
        <div id="welcomeScreen" class="welcome-screen" style="display: flex;">
            <div class="welcome-content">
                <div class="welcome-header">
                    <h1>üöÄ Welcome to GraphBus UI</h1>
                    <p>Agent orchestration and development platform</p>
                </div>

                <div class="project-actions">
                    <div class="project-card" id="newProjectCard">
                        <div class="card-icon">üìù</div>
                        <h2>Create New Project</h2>
                        <p>Start a new GraphBus project with AI-powered agent generation</p>
                        <button class="primary-btn" onclick="showNewProjectForm()">Create Project</button>
                    </div>

                    <div class="project-card" id="openProjectCard">
                        <div class="card-icon">üìÇ</div>
                        <h2>Open Existing Project</h2>
                        <p>Load an existing GraphBus project from a directory</p>
                        <button class="primary-btn" onclick="openExistingProject()">Open Project</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Project Form -->
        <div id="newProjectForm" class="modal" style="display: none;">
            <div class="modal-content large-modal">
                <div class="modal-header">
                    <h2>üìù Create New Project</h2>
                    <button class="modal-close" onclick="closeNewProjectForm()">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- Directory Selection -->
                    <div class="form-section">
                        <label>
                            <h3>üìÅ Project Directory</h3>
                            <p class="hint">Select an empty directory or one without existing .graphbus folder</p>
                        </label>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <input type="text" id="newProjectPath" readonly placeholder="Click browse to select..."
                                style="flex: 1;" />
                            <button onclick="browseNewProjectDirectory()" class="settings-btn">Browse</button>
                        </div>
                        <p id="projectPathError" class="error-message" style="display: none;"></p>
                    </div>

                    <!-- Project Description -->
                    <div class="form-section">
                        <label>
                            <h3>üìã Project Description</h3>
                            <p class="hint">Describe what your agent system should do. Be specific about the
                                functionality you need.</p>
                        </label>
                        <textarea id="projectDescription" rows="4"
                            placeholder="Example: I want to build a chat application where agents handle greetings, process messages, and log all interactions to a file."></textarea>
                    </div>

                    <!-- Template Selection -->
                    <div class="form-section">
                        <label>
                            <h3>üé® Choose Template</h3>
                            <p class="hint">Select a starting template or create from scratch</p>
                        </label>
                        <div class="template-grid">
                            <div class="template-card" data-template="blank" onclick="selectTemplate('blank')">
                                <div class="template-icon">üìÑ</div>
                                <h4>Blank</h4>
                                <p>Start from scratch</p>
                            </div>
                            <div class="template-card" data-template="basic" onclick="selectTemplate('basic')">
                                <div class="template-icon">‚ö°</div>
                                <h4>Basic App</h4>
                                <p>Simple 2-3 agent setup</p>
                            </div>
                            <div class="template-card" data-template="microservices"
                                onclick="selectTemplate('microservices')">
                                <div class="template-icon">üèóÔ∏è</div>
                                <h4>Microservices</h4>
                                <p>Service-oriented architecture</p>
                            </div>
                            <div class="template-card" data-template="data-pipeline"
                                onclick="selectTemplate('data-pipeline')">
                                <div class="template-icon">üîÑ</div>
                                <h4>Data Pipeline</h4>
                                <p>ETL and data processing</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeNewProjectForm()">Cancel</button>
                    <button class="btn-primary" onclick="createNewProject()">üöÄ Create Project</button>
                </div>
            </div>
        </div>

        <!-- Main Layout with Tabs -->
        <div class="main-layout" style="display: none;">
            <!-- Tab Bar -->
            <div class="tab-bar">
                <button class="tab-btn active" data-view="conversation" onclick="switchView('conversation')">
                    üí¨ Conversation
                </button>
                <button class="tab-btn" data-view="graph" onclick="switchView('graph')">
                    üï∏Ô∏è Agent Graph
                </button>
                <button class="tab-btn" data-view="state" onclick="switchView('state')">
                    üîÑ System State
                </button>
                <button class="tab-btn" data-view="files" onclick="switchView('files')">
                    üìÑ Files
                </button>
                <button class="tab-btn" data-view="settings" onclick="switchView('settings')">
                    ‚öôÔ∏è Settings
                </button>
                <div class="tab-status">
                    <span class="status-dot" id="statusDot"></span>
                    <span class="mini-label" id="graphStatus">Auto-updating</span>
                </div>
            </div>

            <!-- View Container -->
            <div class="view-container">
                <!-- Graph View -->
                <div id="graphView" class="view">
                    <div class="view-content" style="padding: 0; position: relative; height: 100%;">
                        <div id="graphCanvas"></div>

                        <!-- Graph Controls -->
                        <div id="graphControls"
                            style="position: absolute; top: 10px; left: 10px; display: flex; gap: 8px; z-index: 10;">
                            <button onclick="fitGraphToView()"
                                style="padding: 8px 12px; background: rgba(102,126,234,0.8); border: 1px solid #667eea; border-radius: 5px; color: white; cursor: pointer; font-size: 11px;">
                                üîç Fit View
                            </button>
                            <button onclick="resetGraphPhysics()"
                                style="padding: 8px 12px; background: rgba(102,126,234,0.8); border: 1px solid #667eea; border-radius: 5px; color: white; cursor: pointer; font-size: 11px;">
                                ‚ö° Reset Layout
                            </button>
                            <button onclick="negotiateAllAgents()"
                                style="padding: 8px 12px; background: rgba(245,158,11,0.8); border: 1px solid #f59e0b; border-radius: 5px; color: white; cursor: pointer; font-size: 11px;">
                                ü§ù Negotiate All
                            </button>
                        </div>

                        <!-- Graph Legend -->
                        <div id="graphLegend"
                            style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); padding: 12px; border-radius: 5px; border: 1px solid #333; font-size: 11px; z-index: 10;">
                            <div style="margin-bottom: 8px; font-weight: bold; color: #888;">Interactions:</div>
                            <div style="margin-bottom: 5px;">üñ±Ô∏è Click - View details & focus</div>
                            <div style="margin-bottom: 5px;">üñ±Ô∏è Double-click - Negotiate</div>
                            <div style="margin-bottom: 5px;">üñ±Ô∏è Drag - Move nodes</div>
                            <div style="margin-bottom: 5px;">üñ±Ô∏è Scroll - Zoom</div>
                            <div style="margin-bottom: 10px;">‚å®Ô∏è +/- keys - Zoom (when focused)</div>
                            <div style="border-top: 1px solid #333; padding-top: 8px; margin-top: 8px;">
                                <div style="margin-bottom: 5px;"><span style="color: #667eea;">‚óè</span> Agent</div>
                                <div><span style="color: #f59e0b;">‚Üí</span> Depends On</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Conversation View -->
                <div id="conversationView" class="view active">
                    <div class="view-content conversation-view-content">
                        <div class="view-header">
                            <h2>üí¨ Conversation</h2>
                        </div>
                        <div class="conversation-messages-view" id="messages"></div>

                        <!-- Conversation Input (Only in this tab) -->
                        <div class="conversation-input-section">
                            <div class="stats-bar">
                                <div class="stat-item working-dir-item">
                                    <span class="stat-label">üìÅ Working Dir:</span>
                                    <span class="stat-value working-dir-path" id="workingDirPath"
                                        title="Click to change">/</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">üìä Status:</span>
                                    <span class="stat-value" id="workflowStatus">Getting Started</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">‚Üí Next:</span>
                                    <span class="stat-value" id="nextAction">Create agents</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Agents:</span>
                                    <span class="stat-value" id="nodesCount">0</span>
                                </div>
                            </div>
                            <div class="chat-input-container">
                                <input type="text" id="chatInput"
                                    placeholder="Type here to chat... (I'll guide you through everything)" autofocus />
                                <button onclick="sendCommand()" id="sendBtn">
                                    <span>Send</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System State View -->
                <div id="stateView" class="view">
                    <div class="view-content" style="padding: 0;">
                        <div class="view-header">
                            <h2>üîÑ System State</h2>
                            <span class="mini-label" id="workflowPhase">Initializing</span>
                        </div>

                        <!-- State Summary -->
                        <div id="systemState" style="padding: 20px; border-bottom: 1px solid #333;">
                            <div style="margin-bottom: 12px;">
                                <strong style="color: #667eea;">Status:</strong>
                                <span id="phaseStatus">Starting up...</span>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <strong style="color: #667eea;">Agents Built:</strong>
                                <span id="builtStatus">Not yet</span>
                            </div>
                            <div>
                                <strong style="color: #667eea;">Runtime:</strong>
                                <span id="runtimeStatus">Stopped</span>
                            </div>
                        </div>

                        <!-- State Files Browser -->
                        <div class="state-browser">
                            <div class="state-sidebar">
                                <h3>üìÇ State Files</h3>
                                <div id="stateFilesList" class="state-files-list">
                                    <div class="state-file-item" onclick="loadStateFile('graph.json', event)">
                                        graph.json
                                    </div>
                                    <div class="state-file-item" onclick="loadStateFile('agents.json', event)">
                                        agents.json
                                    </div>
                                    <div class="state-file-item" onclick="loadStateFile('topics.json', event)">
                                        topics.json
                                    </div>
                                    <div class="state-file-item" onclick="loadStateFile('build_summary.json', event)">
                                        build_summary.json
                                    </div>
                                    <div class="state-file-item" onclick="loadStateFile('conversations.json', event)">
                                        conversations.json
                                    </div>
                                    <div class="state-file-item" onclick="loadStateFile('negotiations.json', event)">
                                        negotiations.json
                                    </div>
                                </div>
                            </div>
                            <div class="state-content">
                                <div class="state-content-header">
                                    <span id="currentStateFile">Select a file to view</span>
                                    <button class="copy-btn" id="copyStateBtn" style="display: none;"
                                        onclick="copyStateContent()">üìã</button>
                                </div>
                                <pre id="stateFileContent"
                                    class="state-file-viewer">Select a file from the left to view its contents</pre>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- Files View -->
                <div id="filesView" class="view">
                    <div class="view-content" style="padding: 0; display: flex; flex-direction: column; height: 100%;">
                        <div class="view-header">
                            <h2>üìÑ File Browser & Editor</h2>
                            <div style="display: flex; gap: 8px;">
                                <button class="refresh-btn" onclick="refreshFileTree()"
                                    title="Refresh file tree">üîÑ</button>
                                <button class="refresh-btn" onclick="collapseAllFolders()"
                                    title="Collapse all folders">üìÅ</button>
                            </div>
                        </div>

                        <!-- File Browser Container -->
                        <div style="display: flex; flex: 1; overflow: hidden; border-top: 1px solid #333;">
                            <!-- File Tree Sidebar -->
                            <div id="fileTreeContainer"
                                style="width: 250px; border-right: 1px solid #333; overflow-y: auto; padding: 12px; background: #0f0f0f;">
                                <div id="fileTree" style="font-size: 13px;">
                                    <div class="loading" style="padding: 20px; text-align: center; color: #666;">Loading
                                        files...</div>
                                </div>
                            </div>

                            <!-- File Editor Panel -->
                            <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                                <!-- File Header -->
                                <div
                                    style="padding: 12px 16px; border-bottom: 1px solid #333; background: #1a1a1a; display: flex; justify-content: space-between; align-items: center;">
                                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                        <span id="currentFilePath"
                                            style="color: #888; font-size: 12px; word-break: break-all;">Select a file
                                            to view</span>
                                        <span id="fileModified"
                                            style="color: #f59e0b; font-size: 11px; display: none;">‚óè Modified</span>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button id="saveFileBtn" class="settings-btn" onclick="saveCurrentFile()"
                                            style="display: none;">üíæ Save</button>
                                        <button id="closeFileBtn" class="settings-btn" onclick="closeCurrentFile()"
                                            style="display: none;">‚úï Close</button>
                                    </div>
                                </div>

                                <!-- File Content -->
                                <div style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                                    <div id="fileEditorContainer" style="flex: 1; overflow: hidden;">
                                        <textarea id="fileEditor"
                                            style="width: 100%; height: 100%; padding: 16px; background: #1a1a1a; border: none; color: #e5e7eb; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Courier New', monospace; font-size: 13px; resize: none; outline: none;"></textarea>
                                    </div>
                                    <div id="fileStats"
                                        style="padding: 8px 16px; background: #0f0f0f; border-top: 1px solid #333; font-size: 11px; color: #888; display: none;">
                                        <span id="lineCount">Lines: 0</span> | <span id="charCount">Chars: 0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings View -->
                <div id="settingsView" class="view">
                    <div class="view-content" style="padding: 20px;">
                        <div class="view-header">
                            <h2>‚öôÔ∏è Settings</h2>
                        </div>
                        <div id="settingsPanel">
                            <div style="padding: 20px;">
                                <!-- API Key Section - Connected View -->
                                <div class="settings-section" id="apiKeyConnectedView" style="display: none;">
                                    <div
                                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="font-weight: 600; color: #667eea;">ü§ñ Claude AI</span>
                                            <span class="status-badge connected" id="claudeStatusBadge">Connected</span>
                                        </div>
                                        <button onclick="showApiKeyConfig()" class="settings-btn">Change Key</button>
                                    </div>
                                    <p style="font-size: 12px; color: #888;">
                                        ‚úì API key configured and ready<br />
                                        üíæ Saved to: <code style="color: #667eea;">~/.graphbus/claude_config.json</code>
                                    </p>
                                </div>

                                <!-- API Key Section - Setup View -->
                                <div class="settings-section" id="apiKeySetupView" style="display: none;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span style="font-weight: 600; color: #667eea;">ü§ñ Claude AI</span>
                                        <span class="status-badge not-configured" id="claudeStatusBadgeSetup">Not
                                            Configured</span>
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <input type="password" id="apiKeyInput" placeholder="sk-ant-api03-..."
                                            class="settings-input" style="width: 100%; margin-bottom: 8px;" />
                                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                            <button onclick="saveApiKey()" class="settings-btn primary">Save &
                                                Connect</button>
                                            <button onclick="toggleApiKeyVisibility()" class="settings-btn">üëÅÔ∏è</button>
                                            <button onclick="hideApiKeyConfig()" class="settings-btn">Cancel</button>
                                        </div>
                                        <button onclick="clearApiKey()" class="settings-btn danger"
                                            style="width: 100%;">Clear Saved Key</button>
                                        <p style="font-size: 11px; color: #888; margin-top: 8px;">
                                            Get your API key from <a href="https://console.anthropic.com/"
                                                target="_blank" style="color: #667eea;">console.anthropic.com</a>
                                        </p>
                                        <p style="font-size: 11px; color: #888; margin-top: 4px;">
                                            üíæ Saved to: <code
                                                style="color: #667eea;">~/.graphbus/claude_config.json</code>
                                        </p>
                                        <p style="font-size: 11px; color: #888; margin-top: 4px;">
                                            üîß Or set: <code style="color: #667eea;">ANTHROPIC_API_KEY</code> env
                                            variable
                                        </p>
                                    </div>
                                </div>

                                <!-- Quick Tips -->
                                <div class="settings-section"
                                    style="border-top: 1px solid #333; padding-top: 16px; margin-top: 16px;">
                                    <div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">üí° Quick Tips
                                    </div>
                                    <div style="color: #aaa; font-size: 13px; line-height: 1.6;">
                                        <p style="margin-bottom: 6px;">‚Ä¢ Chat naturally with Claude AI</p>
                                        <p style="margin-bottom: 6px;">‚Ä¢ Click üìÅ Working Dir to change project</p>
                                        <p style="margin-bottom: 6px;">‚Ä¢ Claude will guide you through setup</p>
                                        <p style="margin-bottom: 6px;">‚Ä¢ Ask "what can I do?" anytime</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Response Toast -->
        <div id="responseToast" class="response-toast hidden">
            <div class="toast-content"></div>
        </div>
    </div>

    <script src="renderer.js"></script>

    <!-- Interactive Prompt Modal -->
    <div id="promptModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚å®Ô∏è Input Required</h2>
            </div>
            <div class="modal-body">
                <pre id="promptQuestion"
                    style="white-space: pre-wrap; background: #1a1a1a; padding: 16px; border-radius: 6px; margin-bottom: 16px;"></pre>
                <input type="text" id="promptInput" placeholder="Enter your response..."
                    style="width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #444; border-radius: 6px; color: #e5e7eb; font-size: 14px;" />
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="submitPromptResponse()">Submit</button>
            </div>
        </div>
    </div>

    <!-- Agent Negotiation Modal -->
    <div id="negotiationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ü§ù Negotiate Agent</h2>
                <button class="modal-close" onclick="closeNegotiationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Agent Info -->
                <div class="agent-info-section">
                    <h3 id="modalAgentName">Agent Name</h3>
                    <div class="agent-meta">
                        <div><strong>Module:</strong> <span id="modalAgentModule"></span></div>
                        <div><strong>Methods:</strong> <span id="modalAgentMethods"></span></div>
                    </div>
                </div>

                <!-- Dependency Graph -->
                <div class="dependency-section">
                    <h4>üìä Dependencies</h4>
                    <div id="modalDependencies" class="dependency-list"></div>
                </div>

                <!-- Intent Input -->
                <div class="intent-section">
                    <label for="negotiationIntent">
                        <h4>üéØ What should this agent focus on?</h4>
                        <p class="hint">Describe your improvement goal (e.g., "optimize performance", "improve error
                            handling")</p>
                    </label>
                    <textarea id="negotiationIntent" rows="4"
                        placeholder="Enter your intent here...&#10;&#10;Examples:&#10;‚Ä¢ Optimize query performance&#10;‚Ä¢ Add comprehensive error handling&#10;‚Ä¢ Improve data validation&#10;‚Ä¢ Enhance logging and monitoring"></textarea>
                </div>

                <!-- Negotiation Options -->
                <div class="options-section">
                    <label>
                        <span>Negotiation Rounds:</span>
                        <input type="number" id="negotiationRounds" value="3" min="1" max="10" />
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeNegotiationModal()">Cancel</button>
                <button class="btn-primary" onclick="submitNegotiation()">ü§ù Start Negotiation</button>
            </div>
        </div>
    </div>
</body>

</html>